set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

# We grab the latest versions that are in the directory
BZR_VERSION=`ls -r bzr/bzr-*.tar.gz | sed 's/bzr\/bzr-\(.*\)\.tar\.gz/\1/' | head -1`

# Set Python path
export PATH=/var/vcap/packages/python/bin:$PATH

# Extract Bazaar package
echo "Extracting Bazaar ${BZR_VERSION}..."
tar xzvf ${BOSH_COMPILE_TARGET}/bzr/bzr-${BZR_VERSION}.tar.gz
if [[ $? != 0 ]] ; then
  echo "Failed extracting Bazaar ${BZR_VERSION}"
  exit 1
fi

# Build Bazaar package
echo "Building Bazaar ${BZR_VERSION}..."
cd ${BOSH_COMPILE_TARGET}/bzr-${BZR_VERSION}
python setup.py install --home ${BOSH_INSTALL_TARGET} build_ext --allow-python-fallback
