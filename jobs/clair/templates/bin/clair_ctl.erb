#!/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status

# Setup common env vars and folders
source /var/vcap/packages/bosh-helpers/ctl_setup.sh 'clair'
export CLAIR_PID_FILE=${CLAIR_PID_DIR}/clair.pid

# Set Python & Bazaar path
export PATH=/var/vcap/packages/python/bin:/var/vcap/packages/bzr/bin:$PATH
export PYTHONPATH=/var/vcap/packages/python:/var/vcap/packages/bzr/lib/python:$PYTHONPATH

case $1 in

  start)
    pid_guard ${CLAIR_PID_FILE} ${JOB_NAME}
    echo $$ > ${CLAIR_PID_FILE}

    # Start Clair service
    exec /var/vcap/packages/clair/bin/clair \
      --log-level=${CLAIR_LOG_LEVEL} \
      --db-type=${CLAIR_DB_TYPE} \
      --db-path=${CLAIR_DB_PATH} \
      --notifier-type=${CLAIR_NOTIFIER_TYPE} \
      --notifier-http-url=${CLAIR_NOTIFIER_HTTP_URL} \
      --update-interval=${CLAIR_UPDATE_INTERVAL} \
      --api-port=${CLAIR_API_PORT} \
      --api-timeout=${CLAIR_API_TIMEOUT} \
      ${CLAIR_API_CA_FILE:-} \
      ${CLAIR_API_CERT_FILE:-} \
      ${CLAIR_API_KEY_FILE:-} \
      ${CLAIR_CPU_PROFILE_PATH:-} \
      >>${CLAIR_LOG_DIR}/${OUTPUT_LABEL}.stdout.log \
      2>>${CLAIR_LOG_DIR}/${OUTPUT_LABEL}.stderr.log
    ;;

  stop)
    # Stop Clair service
    kill_and_wait ${CLAIR_PID_FILE}
    ;;

  *)
    echo "Usage: $0 {start|stop}"
    exit 1
    ;;

esac
exit 0
